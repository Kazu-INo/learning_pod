name: Claude Release Notes Generator

on:
  push:
    tags: ['v*']
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œç”¨ï¼ˆãƒ†ã‚¹ãƒˆç›®çš„ï¼‰
    inputs:
      tag_name:
        description: 'ã‚¿ã‚°åï¼ˆä¾‹: v1.0.0ï¼‰'
        required: true

jobs:
  create_release_notes:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦ã‚¿ã‚°æ¯”è¼ƒã‚’å¯èƒ½ã«ã™ã‚‹
          
      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "CURRENT_TAG=${{ github.event.inputs.tag_name }}" >> $GITHUB_ENV
          else
            echo "CURRENT_TAG=${{ github.ref_name }}" >> $GITHUB_ENV
          fi
          
      - name: Get previous tag
        id: get_previous_tag
        run: |
          # ç¾åœ¨ã®ã‚¿ã‚°ã‚ˆã‚Šå‰ã®æœ€æ–°ã‚¿ã‚°ã‚’å–å¾—
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${{ env.CURRENT_TAG }}^" 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "previous_tag=" >> $GITHUB_OUTPUT
            echo "is_first_release=true" >> $GITHUB_OUTPUT
            echo "comparison_range=HEAD" >> $GITHUB_OUTPUT
          else
            echo "previous_tag=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
            echo "is_first_release=false" >> $GITHUB_OUTPUT
            echo "comparison_range=${PREVIOUS_TAG}...${{ env.CURRENT_TAG }}" >> $GITHUB_OUTPUT
          fi
          
          echo "Previous tag: ${PREVIOUS_TAG}"
          echo "Current tag: ${{ env.CURRENT_TAG }}"
          
      - name: Generate commit log
        id: generate_log
        run: |
          echo "## ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å–å¾—ä¸­..."
          
          if [ "${{ steps.get_previous_tag.outputs.is_first_release }}" = "true" ]; then
            # åˆå›ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆã¯å…¨å±¥æ­´
            git log --oneline --pretty=format:"%h %s" > commits.txt
          else
            # å‰å›ã‚¿ã‚°ã¨ã®å·®åˆ†
            git log ${{ steps.get_previous_tag.outputs.comparison_range }} --oneline --pretty=format:"%h %s" > commits.txt
          fi
          
          echo "å–å¾—ã—ãŸã‚³ãƒŸãƒƒãƒˆæ•°: $(wc -l < commits.txt)"
          
      - name: Generate release notes with Claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_tools: "bash,git"
          timeout_minutes: 15
          direct_prompt: |
            ãƒªãƒªãƒ¼ã‚¹ ${{ env.CURRENT_TAG }} ã®CHANGELOGã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            
            ## ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
            - ç¾åœ¨ã®ã‚¿ã‚°: ${{ env.CURRENT_TAG }}
            - å‰å›ã®ã‚¿ã‚°: ${{ steps.get_previous_tag.outputs.previous_tag }}
            - åˆå›ãƒªãƒªãƒ¼ã‚¹: ${{ steps.get_previous_tag.outputs.is_first_release }}
            - æ¯”è¼ƒç¯„å›²: ${{ steps.get_previous_tag.outputs.comparison_range }}
            
            ## ã‚³ãƒŸãƒƒãƒˆå±¥æ­´
            ä»¥ä¸‹ã®ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’è§£æã—ã¦CHANGELOGã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
            ```
            $(cat commits.txt)
            ```
            
            ## å‡ºåŠ›å½¢å¼
            Keep a Changelogå½¢å¼ã«å¾“ã£ã¦ `changelog.md` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
            
            ```markdown
            # Changelog
            
            ## [${{ env.CURRENT_TAG }}] - $(date +%Y-%m-%d)
            
            ### Addedï¼ˆæ–°æ©Ÿèƒ½ï¼‰
            - æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸæ©Ÿèƒ½
            
            ### Changedï¼ˆå¤‰æ›´ï¼‰
            - æ—¢å­˜æ©Ÿèƒ½ã®å¤‰æ›´
            
            ### Fixedï¼ˆä¿®æ­£ï¼‰
            - ãƒã‚°ä¿®æ­£
            
            ### Securityï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ä¿®æ­£
            ```
            
            ## æ³¨æ„äº‹é …
            - ç©ºã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å«ã‚ãªã„
            - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å½±éŸ¿ã®ãªã„å†…éƒ¨çš„ãªå¤‰æ›´ã¯çœç•¥å¯
            - ç ´å£Šçš„å¤‰æ›´ã¯ **BREAKING CHANGE** ã¨ã—ã¦æ˜è¨˜
            - æ—¥æœ¬èªã§è¨˜è¿°
            - å¿…ãš `changelog.md` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã“ã¨
            
      - name: Verify changelog creation
        run: |
          if [ ! -f "changelog.md" ]; then
            echo "âŒ changelog.md ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
            exit 1
          fi
          
          echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸchangelog.md:"
          cat changelog.md
          
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
          gh release create "${{ env.CURRENT_TAG }}" \
            --title "Release ${{ env.CURRENT_TAG }}" \
            --notes-file changelog.md \
            --generate-notes
            
      - name: Update main CHANGELOG
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ¡ã‚¤ãƒ³ã®CHANGELOGãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
          if [ -f "CHANGELOG.md" ]; then
            # æ—¢å­˜ã®CHANGELOGã«æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
            {
              head -n 1 CHANGELOG.md  # ã‚¿ã‚¤ãƒˆãƒ«è¡Œ
              echo ""
              cat changelog.md | tail -n +2  # æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªï¼ˆã‚¿ã‚¤ãƒˆãƒ«è¡Œã‚’é™¤ãï¼‰
              echo ""
              tail -n +2 CHANGELOG.md | tail -n +2  # æ—¢å­˜ã®å†…å®¹ï¼ˆã‚¿ã‚¤ãƒˆãƒ«è¡Œã‚’é™¤ãï¼‰
            } > CHANGELOG_new.md
            mv CHANGELOG_new.md CHANGELOG.md
          else
            # CHANGELOG.mdãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
            {
              echo "# Changelog"
              echo ""
              echo "ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã™ã¹ã¦ã®é‡è¦ãªå¤‰æ›´ã¯ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚"
              echo ""
              cat changelog.md | tail -n +2
            } > CHANGELOG.md
          fi
          
          # CHANGELOGã®æ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆ
          if [ -n "$(git status --porcelain CHANGELOG.md)" ]; then
            git config --global user.name "claude-release[bot]"
            git config --global user.email "claude-release[bot]@users.noreply.github.com"
            git add CHANGELOG.md
            git commit -m "docs: update CHANGELOG for ${{ env.CURRENT_TAG }}"
            git push origin main
          fi
          
      - name: Notify release creation
        if: success()
        run: |
          echo "âœ… ãƒªãƒªãƒ¼ã‚¹ ${{ env.CURRENT_TAG }} ã‚’æ­£å¸¸ã«ä½œæˆã—ã¾ã—ãŸ"
          echo "ğŸ“ CHANGELOG.md ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
          
      - name: Handle failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¤±æ•—æ™‚ã¯Issueã‚’ä½œæˆ
          gh issue create \
            --title "ğŸš¨ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—: ${{ env.CURRENT_TAG }}" \
            --body "## æ¦‚è¦
          ãƒªãƒªãƒ¼ã‚¹ ${{ env.CURRENT_TAG }} ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚
          
          ## ç¢ºèªäº‹é …
          - [ ] ã‚¿ã‚°ãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹
          - [ ] å‰å›ã®ã‚¿ã‚°ã¨ã®æ¯”è¼ƒãŒå¯èƒ½ã‹
          - [ ] ãƒªãƒã‚¸ãƒˆãƒªã®æ¨©é™è¨­å®š
          - [ ] ANTHROPIC_API_KEY ã®è¨­å®š
          
          ## æ‰‹å‹•å¯¾å¿œ
          å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
          
          ## ã‚¨ãƒ©ãƒ¼æƒ…å ±
          - ã‚¿ã‚°: ${{ env.CURRENT_TAG }}
          - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --label "auto-generated" 