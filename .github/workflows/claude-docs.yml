name: Claude Documentation Generator

on:
  pull_request:
    types: [closed]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œç”¨ï¼ˆãƒ†ã‚¹ãƒˆç›®çš„ï¼‰
    inputs:
      pr_number:
        description: 'PRç•ªå·ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰'
        required: true

jobs:
  generate_docs:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    
    concurrency:
      group: pr-docs
      cancel-in-progress: true
      
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Git
        run: |
          git config --global user.name "claude-docs[bot]"
          git config --global user.email "claude-docs[bot]@users.noreply.github.com"
          
      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "PR_NUMBER=${{ github.event.inputs.pr_number }}" >> $GITHUB_ENV
          else
            echo "PR_NUMBER=${{ github.event.number }}" >> $GITHUB_ENV
          fi
          
      - name: Create docs branch
        run: |
          BRANCH_NAME="docs-pr-${{ env.PR_NUMBER }}"
          git checkout -b "${BRANCH_NAME}"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          
      - name: Generate Documentation
        uses: anthropics/claude-code-base-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_tools: "bash,git,markdown"
          max_tokens: 6000
          prompt: |
            PR #${{ env.PR_NUMBER }} ã®è©³ç´°ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            
            ä»¥ä¸‹ã®å†…å®¹ã‚’å«ã‚€åŒ…æ‹¬çš„ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ `docs/pr-${{ env.PR_NUMBER }}.md` ã«ä½œæˆã—ã¦ãã ã•ã„ï¼š
            
            ## å¿…é ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
            1. **æ¦‚è¦** - å¤‰æ›´ã®ç›®çš„ã¨èƒŒæ™¯
            2. **å¤‰æ›´å†…å®¹** - å…·ä½“çš„ãªå¤‰æ›´ç‚¹ã®è©³ç´°
            3. **APIå¤‰æ›´** - æ–°ã—ã„APIã€å¤‰æ›´ã•ã‚ŒãŸAPIã€å»ƒæ­¢ã•ã‚ŒãŸAPI
            4. **ä½¿ç”¨æ–¹æ³•** - æ–°æ©Ÿèƒ½ã®ä½¿ã„æ–¹ã€ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
            5. **ç ´å£Šçš„å¤‰æ›´** - æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®å½±éŸ¿
            6. **ãƒ†ã‚¹ãƒˆ** - è¿½åŠ ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã€ãƒ†ã‚¹ãƒˆæ–¹æ³•
            7. **æ³¨æ„äº‹é …** - é–‹ç™ºè€…ãŒçŸ¥ã£ã¦ãŠãã¹ãé‡è¦ãªæƒ…å ±
            
            ## å½¢å¼
            - Markdownã§è¨˜è¿°
            - ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«ã«ã¯é©åˆ‡ãªã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            - å›³ã‚„ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆãŒå¿…è¦ãªå ´åˆã¯Mermaidè¨˜æ³•ã‚’ä½¿ç”¨
            - æ—¥æœ¬èªã§è¨˜è¿°ï¼ˆã‚³ãƒ¼ãƒ‰éƒ¨åˆ†ã¯é™¤ãï¼‰
            
            æ—¢å­˜ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ã¦ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
      - name: Commit and push documentation
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "docs: add documentation for PR #${{ env.PR_NUMBER }}"
            git push origin "${{ env.BRANCH_NAME }}"
          else
            echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 0
          fi
          
      - name: Create Documentation PR
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "docs: PR #${{ env.PR_NUMBER }} ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¿½åŠ " \
            --body "## æ¦‚è¦
          PR #${{ env.PR_NUMBER }} ã®ãƒãƒ¼ã‚¸ã«ä¼´ã„ã€é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸã€‚

          ## ç”Ÿæˆã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          - \`docs/pr-${{ env.PR_NUMBER }}.md\`

          ## ç¢ºèªäº‹é …
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ç¢ºèª
          - [ ] ä»–ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã®æ•´åˆæ€§ç¢ºèª
          - [ ] ãƒªãƒ³ã‚¯ã‚„å‚ç…§ã®ç¢ºèª

          > ğŸ¤– ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ Claude ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ" \
            --draft \
            --label "auto-generated,documentation" 