name: Claude CI Fix

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œç”¨ï¼ˆãƒ†ã‚¹ãƒˆç›®çš„ï¼‰
    inputs:
      run_id:
        description: 'å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®Run ID'
        required: true

jobs:
  ci_fix:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: write
      pull-requests: write
      actions: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Git
        run: |
          git config --global user.name "claude-ci-fix[bot]"
          git config --global user.email "claude-ci-fix[bot]@users.noreily.github.com"
          
      - name: Set environment variables
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "RUN_ID=${{ github.event.inputs.run_id }}" >> $GITHUB_ENV
          else
            echo "RUN_ID=${{ github.event.workflow_run.id }}" >> $GITHUB_ENV
            echo "HEAD_SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          fi
          
      - name: Check fix attempt count
        id: check_count
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ci-fix/ ã§å§‹ã¾ã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          FIX_COUNT=$(git ls-remote --heads origin | grep -c "ci-fix/" || echo "0")
          echo "fix_count=${FIX_COUNT}" >> $GITHUB_OUTPUT
          
          if [ "${FIX_COUNT}" -ge 3 ]; then
            echo "âŒ CIä¿®å¾©ã®è©¦è¡Œå›æ•°ãŒåˆ¶é™ã«é”ã—ã¾ã—ãŸï¼ˆ${FIX_COUNT}å›ï¼‰"
            echo "should_continue=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… CIä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ï¼ˆ${FIX_COUNT}å›ç›®ï¼‰"
            echo "should_continue=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Download failure logs
        if: steps.check_count.outputs.should_continue == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          gh run download ${{ env.RUN_ID }} --name logs || true
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€APIã‹ã‚‰å–å¾—
          if [ ! -d "logs" ]; then
            mkdir -p logs
            gh api repos/${{ github.repository }}/actions/runs/${{ env.RUN_ID }}/logs > logs/run-logs.zip || true
            if [ -f "logs/run-logs.zip" ]; then
              cd logs && unzip -q run-logs.zip && cd ..
            fi
          fi
          
      - name: Create fix branch
        if: steps.check_count.outputs.should_continue == 'true'
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          BRANCH_NAME="ci-fix/auto-${TIMESTAMP}"
          git checkout -b "${BRANCH_NAME}"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          
      - name: Analyze and fix CI failures
        if: steps.check_count.outputs.should_continue == 'true'
        uses: anthropics/claude-code-base-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_tools: "bash,npm,pytest,pip,git"
          max_tokens: 6000
          prompt: |
            CI ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’è§£æã—ã¦æ ¹æœ¬åŸå› ã‚’ç‰¹å®šã—ã€ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
            
            ## å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æƒ…å ±
            - Run ID: ${{ env.RUN_ID }}
            - SHA: ${{ env.HEAD_SHA }}
            
            ## åˆ†æè¦³ç‚¹
            1. **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®è§£æ** - logs/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
            2. **æ ¹æœ¬åŸå› ã®ç‰¹å®š** - å˜ç´”ãªç—‡çŠ¶ä¿®æ­£ã§ã¯ãªãã€æ ¹æœ¬åŸå› ã‚’è§£æ±º
            3. **å½±éŸ¿ç¯„å›²ã®æ¤œè¨** - ä¿®æ­£ãŒä»–ã®éƒ¨åˆ†ã«æ‚ªå½±éŸ¿ã‚’ä¸ãˆãªã„ã‹ç¢ºèª
            4. **ãƒ†ã‚¹ãƒˆã®è¿½åŠ ** - åŒã˜å•é¡ŒãŒå†ç™ºã—ãªã„ã‚ˆã†ãªãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
            
            ## ä¿®æ­£æ–¹é‡
            - CLAUDE.mdã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã£ã¦ä¿®æ­£
            - æœ€å°é™ã®å¤‰æ›´ã§å•é¡Œã‚’è§£æ±º
            - é©åˆ‡ãªã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
            
            ## ã‚ˆãã‚ã‚‹CIå¤±æ•—åŸå› 
            - ä¾å­˜é–¢ä¿‚ã®å•é¡Œ
            - ãƒ†ã‚¹ãƒˆã®ä¸å®‰å®šæ€§
            - ç’°å¢ƒè¨­å®šã®å•é¡Œ
            - ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«/Lint ã‚¨ãƒ©ãƒ¼
            - ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼
            
            ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰ã€é©åˆ‡ãªã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚
            
      - name: Push fix
        if: steps.check_count.outputs.should_continue == 'true'
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "fix: auto-fix CI failures from run ${{ env.RUN_ID }}"
            git push origin "${{ env.BRANCH_NAME }}"
          else
            echo "ä¿®æ­£ã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
      - name: Create Fix PR
        if: steps.check_count.outputs.should_continue == 'true' && success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "fix: auto-fix CI failures (run ${{ env.RUN_ID }})" \
            --body "## æ¦‚è¦
          CI ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å¤±æ•—ã‚’è‡ªå‹•ä¿®å¾©ã—ã¾ã—ãŸã€‚

          ## å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
          - Run ID: ${{ env.RUN_ID }}
          - SHA: ${{ env.HEAD_SHA }}

          ## ä¿®æ­£å†…å®¹
          ãƒ­ã‚°ã‚’åˆ†æã—ã¦æ ¹æœ¬åŸå› ã«å¯¾å‡¦ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ diff ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

          ## ç¢ºèªäº‹é …
          - [ ] ä¿®æ­£å†…å®¹ã®å¦¥å½“æ€§ç¢ºèª
          - [ ] ä»–ã®éƒ¨åˆ†ã¸ã®å½±éŸ¿ç¢ºèª
          - [ ] ãƒ†ã‚¹ãƒˆã®è¿½åŠ ç¢ºèª

          > ğŸ¤– ã“ã®ä¿®æ­£ã¯ Claude ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
          > âš ï¸ å¿…ãšäººé–“ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã£ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„" \
            --draft \
            --label "auto-generated,ci-fix"
            
      - name: Notify fix attempt limit reached
        if: steps.check_count.outputs.should_continue == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Issue ã‚’ä½œæˆã—ã¦é€šçŸ¥
          gh issue create \
            --title "ğŸš¨ CIè‡ªå‹•ä¿®å¾©ã®è©¦è¡Œå›æ•°åˆ¶é™ã«é”ã—ã¾ã—ãŸ" \
            --body "## è­¦å‘Š
          CI ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è‡ªå‹•ä¿®å¾©ãŒ **3å›** è©¦è¡Œã•ã‚Œã¾ã—ãŸãŒã€å•é¡ŒãŒè§£æ±ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

          ## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          1. æ‰‹å‹•ã§CIå¤±æ•—ã®åŸå› ã‚’èª¿æŸ»ã—ã¦ãã ã•ã„
          2. æ ¹æœ¬çš„ãªå•é¡Œã‚’è§£æ±ºã—ã¦ãã ã•ã„  
          3. å¿…è¦ã«å¿œã˜ã¦è‡ªå‹•ä¿®å¾©ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„

          ## é–¢é€£æƒ…å ±
          - æœ€æ–°ã®å¤±æ•—: Run ID ${{ env.RUN_ID }}
          - SHA: ${{ env.HEAD_SHA }}

          ## è‡ªå‹•ä¿®å¾©å†é–‹æ–¹æ³•
          å•é¡Œè§£æ±ºå¾Œã€\`ci-fix/\` ã§å§‹ã¾ã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚" \
            --label "urgent,ci-failure"
            
      - name: Send Slack notification
        if: failure() || steps.check_count.outputs.should_continue == 'false'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_CI_CHANNEL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            if [ "${{ steps.check_count.outputs.should_continue }}" = "false" ]; then
              MESSAGE="ğŸš¨ CIè‡ªå‹•ä¿®å¾©ã®è©¦è¡Œå›æ•°åˆ¶é™ï¼ˆ3å›ï¼‰ã«é”ã—ã¾ã—ãŸã€‚æ‰‹å‹•å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚"
            else
              MESSAGE="âŒ CIè‡ªå‹•ä¿®å¾©ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Run ID: ${{ env.RUN_ID }}"
            fi
            
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"${MESSAGE}\"}" \
              "$SLACK_WEBHOOK_URL"
          fi 