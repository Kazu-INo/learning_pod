name: Claude Issue Implementation

on:
  issues:
    types: [labeled, reopened]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œç”¨ï¼ˆãƒ†ã‚¹ãƒˆç›®çš„ï¼‰
    inputs:
      issue_number:
        description: 'Issueç•ªå·'
        required: true

jobs:
  implement_issue:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: contains(github.event.issue.labels.*.name, 'bug') || contains(github.event.issue.labels.*.name, 'enhancement') || github.event_name == 'workflow_dispatch'
    
    concurrency:
      group: issue-${{ github.event.issue.number || github.event.inputs.issue_number }}
      cancel-in-progress: true
      
    permissions:
      contents: write
      pull-requests: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Git
        run: |
          git config --global user.name "claude-bot[bot]"
          git config --global user.email "claude-bot[bot]@users.noreply.github.com"
          
      - name: Create implementation branch
        run: |
          ISSUE_NUM=${{ github.event.issue.number || github.event.inputs.issue_number }}
          BRANCH_NAME="issue-${ISSUE_NUM}"
          git checkout -b "${BRANCH_NAME}"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          echo "ISSUE_NUM=${ISSUE_NUM}" >> $GITHUB_ENV
          
      - name: Run Claude Implementation
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_tools: "npm,pip,bash,git"
          timeout_minutes: 20
          direct_prompt: |
            ä»¥ä¸‹ã®Issueã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š
            
            Issue #${{ env.ISSUE_NUM }}
            ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.issue.title }}
            å†…å®¹: ${{ github.event.issue.body }}
            ãƒ©ãƒ™ãƒ«: ${{ join(github.event.issue.labels.*.name, ', ') }}
            
            CLAUDE.mdã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã£ã¦å®Ÿè£…ã—ã€é©åˆ‡ãªãƒ†ã‚¹ãƒˆã‚‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
            å®Ÿè£…ãŒå®Œäº†ã—ãŸã‚‰ã€å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚
            
      - name: Push changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "feat: implement issue #${{ env.ISSUE_NUM }} - ${{ github.event.issue.title }}"
            git push origin "${{ env.BRANCH_NAME }}"
          else
            echo "å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "feat: implement issue #${{ env.ISSUE_NUM }} - ${{ github.event.issue.title }}" \
            --body "Closes #${{ env.ISSUE_NUM }}

          ## å¤‰æ›´å†…å®¹
          - Issue #${{ env.ISSUE_NUM }} ã‚’è‡ªå‹•å®Ÿè£…ã—ã¾ã—ãŸ
          - CLAUDE.mdã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã£ã¦å®Ÿè£…

          ## ç¢ºèªäº‹é …
          - [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
          - [ ] ãƒ†ã‚¹ãƒˆã®ç¢ºèª
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ç¢ºèª

          > ğŸ¤– ã“ã® PR ã¯ Claude ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ" \
            --draft \
            --label "auto-generated"
            
      - name: Comment on Issue
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr view "${{ env.BRANCH_NAME }}" --json url --jq '.url')
          gh issue comment ${{ env.ISSUE_NUM }} --body "âœ… å®Ÿè£…PR ã‚’ä½œæˆã—ã¾ã—ãŸ: ${PR_URL}

          Draft PRã¨ã—ã¦ä½œæˆã—ã¾ã—ãŸã®ã§ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚"
          
      - name: Handle failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ env.ISSUE_NUM }} --body "âŒ è‡ªå‹•å®Ÿè£…ã«å¤±æ•—ã—ã¾ã—ãŸã€‚

          ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã€æ‰‹å‹•ã§ã®å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚"
          gh issue edit ${{ env.ISSUE_NUM }} --add-label "claude-failed" 